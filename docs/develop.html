<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Developer Guide &#8212; pyPDAF  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=8203d6f3" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API" href="API.html" />
    <link rel="prev" title="Parallelisation Strategy" href="parallel.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="developer-guide">
<h1>Developer Guide<a class="headerlink" href="#developer-guide" title="Link to this heading">¶</a></h1>
<p>The following guide explains the structure, implementation details, and mechanisms
used in <code class="docutils literal notranslate"><span class="pre">pyPDAF</span></code>. This guide is aimed at developers who wish to understand the
existing framework, make modifications, or contribute to its development.</p>
<hr class="docutils" />
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">pyPDAF</span></code> bridges Python and Fortran by leveraging the <code class="docutils literal notranslate"><span class="pre">Cython</span></code> library.
As Python is implemented in C, any interaction between Python and Fortran is
effectively handled as C-to-Fortran communication.</p>
<p><code class="docutils literal notranslate"><span class="pre">Cython</span></code> automatically converts its module to <code class="docutils literal notranslate"><span class="pre">C</span></code> source code. The interoperability
with <code class="docutils literal notranslate"><span class="pre">Fortran</span></code> is achieved by the Fortran 2003 feature <code class="docutils literal notranslate"><span class="pre">iso_c_binding</span></code> module.</p>
<p>Contributions to the library can include raising issues, suggesting features,
or submitting pull requests with code enhancements.</p>
</section>
<hr class="docutils" />
<section id="adding-a-new-fortran-function-in-pypdaf">
<h2>Adding a new Fortran function in pyPDAF<a class="headerlink" href="#adding-a-new-fortran-function-in-pypdaf" title="Link to this heading">¶</a></h2>
<section id="fortran-subroutines-and-wrappers">
<h3>Fortran Subroutines and Wrappers<a class="headerlink" href="#fortran-subroutines-and-wrappers" title="Link to this heading">¶</a></h3>
<p>The Fortran subroutine wrappers that are interoperable with C functions are
given in <a class="reference internal" href="#src/fortran"><span class="xref myst">src/fortran</span></a>.</p>
<section id="interoperability-with-bind-c">
<h4>Interoperability with <code class="docutils literal notranslate"><span class="pre">bind(c)</span></code><a class="headerlink" href="#interoperability-with-bind-c" title="Link to this heading">¶</a></h4>
<p>Fortran subroutines use the <code class="docutils literal notranslate"><span class="pre">bind(c)</span></code> keyword for compatibility with C.</p>
<p>Since PDAF does not use this keyword, <code class="docutils literal notranslate"><span class="pre">pyPDAF</span></code> provides its own wrapper subroutines that:</p>
<ol class="arabic simple">
<li><p>Subroutine names begin with the prefix <code class="docutils literal notranslate"><span class="pre">c__</span></code> to denote compatibility.</p></li>
<li><p>Arguments use corresponding C types.</p></li>
<li><p>User-supplied functions must be declared with <a class="reference internal" href="#src/fortran/pdaf_c_cb_interface.f90"><span class="xref myst">specified interface</span></a></p></li>
<li><p>Bind(c) user-supplied functions must be converted to Fortran subroutines by
pointers and wrapper subroutines in <a class="reference internal" href="#src/fortran/pdaf_c_f_interface.f90"><span class="xref myst">src/fortran/pdaf_c_f_interface.f90</span></a>.
This is a requirement in <code class="docutils literal notranslate"><span class="pre">flang</span></code>.</p></li>
<li><p>We do not use features that interoperable with derived types. This is because
current standard does not support allocatable arrays in derived types.
Therefore, <code class="docutils literal notranslate"><span class="pre">obs_f</span></code> and <code class="docutils literal notranslate"><span class="pre">obs_l</span></code> in PDAFomi are allocated in Fortran referenced
by indices, and getting and setter functions.</p></li>
</ol>
</section>
<section id="example-wrapper-subroutine">
<h4>Example Wrapper Subroutine<a class="headerlink" href="#example-wrapper-subroutine" title="Link to this heading">¶</a></h4>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">subroutine </span><span class="n">c__PDAFomi_set_doassim</span><span class="p">(</span><span class="n">i_obs</span><span class="p">,</span><span class="w"> </span><span class="n">doassim</span><span class="p">)</span><span class="w"> </span><span class="k">bind</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="w">   </span><span class="c">! Index of observation types</span>
<span class="w">   </span><span class="kt">integer</span><span class="p">(</span><span class="kt">c_int</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i_obs</span>
<span class="w">   </span><span class="c">! Flag to determine assimilation (0: no, 1: yes)</span>
<span class="w">   </span><span class="kt">integer</span><span class="p">(</span><span class="kt">c_int</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">doassim</span>
<span class="w">   </span><span class="n">thisobs</span><span class="p">(</span><span class="n">i_obs</span><span class="p">)%</span><span class="n">doassim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">doassim</span>
<span class="k">end subroutine </span><span class="n">c__PDAFomi_set_doassim</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="cython-integration">
<h3>Cython Integration<a class="headerlink" href="#cython-integration" title="Link to this heading">¶</a></h3>
<section id="cython-declarations">
<h4>Cython Declarations<a class="headerlink" href="#cython-declarations" title="Link to this heading">¶</a></h4>
<p>To call Fortran subroutines in Python, <code class="docutils literal notranslate"><span class="pre">pyPDAF</span></code> uses Cython declarations
defined in <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> files (e.g., <code class="docutils literal notranslate"><span class="pre">src/pyPDAF/PDAF.pxd</span></code>). Example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span><span class="w"> </span><span class="kr">extern</span> <span class="kt">void</span> <span class="nf">c__pdaf_eofcovar</span><span class="w"> </span><span class="p">(</span>
    <span class="nb">int</span><span class="o">*</span> <span class="n">dim_state</span><span class="p">,</span> <span class="nb">int</span><span class="o">*</span> <span class="n">nstates</span><span class="p">,</span> <span class="nb">int</span><span class="o">*</span> <span class="n">nfields</span><span class="p">,</span> <span class="nb">int</span><span class="o">*</span> <span class="n">dim_fields</span><span class="p">,</span>
    <span class="nb">int</span><span class="o">*</span> <span class="n">offsets</span><span class="p">,</span> <span class="nb">int</span><span class="o">*</span> <span class="n">remove_mstate</span><span class="p">,</span> <span class="nb">int</span><span class="o">*</span> <span class="n">do_mv</span><span class="p">,</span> <span class="n">double</span><span class="o">*</span> <span class="n">states</span><span class="p">,</span>
    <span class="n">double</span><span class="o">*</span> <span class="n">stddev</span><span class="p">,</span> <span class="n">double</span><span class="o">*</span> <span class="n">svals</span><span class="p">,</span> <span class="n">double</span><span class="o">*</span> <span class="n">svec</span><span class="p">,</span> <span class="n">double</span><span class="o">*</span> <span class="n">meanstate</span><span class="p">,</span>
    <span class="nb">int</span><span class="o">*</span> <span class="n">verbose</span><span class="p">,</span> <span class="nb">int</span><span class="o">*</span> <span class="n">status</span><span class="p">)</span> <span class="n">noexcept</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="python-wrappers">
<h4>Python Wrappers<a class="headerlink" href="#python-wrappers" title="Link to this heading">¶</a></h4>
<p>These Cython declarations are wrapped into Python functions to make them
accessible to users. Wrappers should return all <code class="docutils literal notranslate"><span class="pre">intent(out)</span></code> or <code class="docutils literal notranslate"><span class="pre">intent(inout)</span></code>
arguments in Python-friendly structures.</p>
<p>Example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">eofcovar</span><span class="p">(</span><span class="nb">int</span>  <span class="n">dim</span><span class="p">,</span> <span class="nb">int</span>  <span class="n">nstates</span><span class="p">,</span> <span class="nb">int</span>  <span class="n">nfields</span><span class="p">,</span> <span class="nb">int</span> <span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">dim_fields</span><span class="p">,</span>
    <span class="nb">int</span> <span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">offsets</span><span class="p">,</span> <span class="nb">int</span>  <span class="n">remove_mstate</span><span class="p">,</span> <span class="nb">int</span>  <span class="n">do_mv</span><span class="p">,</span>
    <span class="n">double</span> <span class="p">[::</span><span class="mf">1</span><span class="p">,:]</span> <span class="n">states</span><span class="p">,</span> <span class="n">double</span> <span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">meanstate</span><span class="p">,</span> <span class="nb">int</span>  <span class="n">verbose</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    EOF analysis of an ensemble of state vectors by singular value decomposition.</span>

<span class="sd">    Typically, this function is used with :func:`pyPDAF.PDAF.SampleEns`</span>
<span class="sd">    to generate an ensemble of a chosen size (up to the number of EOFs plus one).</span>

<span class="sd">    Here, the function performs a singular value decomposition</span>
<span class="sd">    of the ensemble anomaly of the input matrix,</span>
<span class="sd">    which is usually an ensemble formed by state vectors</span>
<span class="sd">    at multiple time steps.</span>
<span class="sd">    The singular values and corresponding singular vectors</span>
<span class="sd">    can be used to construct a covariance matrix.</span>
<span class="sd">    This can be used as the initial error covariance for the initial ensemble.</span>

<span class="sd">    A multivariate scaling can be performed to ensure that all fields</span>
<span class="sd">    in the state vectors have unit variance.</span>

<span class="sd">    It can be useful to store more EOFs than one finally</span>
<span class="sd">    might want to use to have the flexibility</span>
<span class="sd">    to carry the ensemble size.</span>


<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    `PDAF webpage &lt;https://pdaf.awi.de/trac/wiki/EnsembleGeneration&gt;`_</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dim : int</span>
<span class="sd">        Dimension of state vector</span>
<span class="sd">    nstates : int</span>
<span class="sd">        Number of state vectors</span>
<span class="sd">    nfields : int</span>
<span class="sd">        Number of fields in state vector</span>
<span class="sd">    dim_fields : ndarray[np.intc, ndim=1]</span>
<span class="sd">        Size of each field</span>
<span class="sd">        Array shape: (nfields)</span>
<span class="sd">    offsets : ndarray[np.intc, ndim=1]</span>
<span class="sd">        Start position of each field</span>
<span class="sd">        Array shape: (nfields)</span>
<span class="sd">    remove_mstate : int</span>
<span class="sd">        1: subtract mean state from states</span>
<span class="sd">    do_mv : int</span>
<span class="sd">        1: Do multivariate scaling; 0: no scaling</span>
<span class="sd">    states : ndarray[np.float64, ndim=2]</span>
<span class="sd">        State perturbations</span>
<span class="sd">        Array shape: (dim, nstates)</span>
<span class="sd">    meanstate : ndarray[np.float64, ndim=1]</span>
<span class="sd">        Mean state (only changed if remove_mstate=1)</span>
<span class="sd">        Array shape: (dim)</span>
<span class="sd">    verbose : int</span>
<span class="sd">        Verbosity flag</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    states : ndarray[np.float64, ndim=2]</span>
<span class="sd">        State perturbations</span>
<span class="sd">        Array shape: (dim, nstates)</span>
<span class="sd">    stddev : ndarray[np.float64, ndim=1]</span>
<span class="sd">        Standard deviation of field variability</span>
<span class="sd">        Array shape: (nfields)</span>
<span class="sd">    svals : ndarray[np.float64, ndim=1]</span>
<span class="sd">        Singular values divided by sqrt(nstates-1)</span>
<span class="sd">        Array shape: (nstates)</span>
<span class="sd">    svec : ndarray[np.float64, ndim=2]</span>
<span class="sd">        Singular vectors</span>
<span class="sd">        Array shape: (dim, nstates)</span>
<span class="sd">    meanstate : ndarray[np.float64, ndim=1]</span>
<span class="sd">        Mean state (only changed if remove_mstate=1)</span>
<span class="sd">        Array shape: (dim)</span>
<span class="sd">    status : int</span>
<span class="sd">        Status flag</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">cdef</span><span class="w"> </span><span class="kt">cnp</span>.<span class="kt">ndarray</span>[<span class="kt">cnp</span>.<span class="nf">float64_t</span><span class="p">,</span> <span class="nf">ndim</span><span class="o">=</span><span class="mf">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;fortran&quot;</span><span class="p">,</span> <span class="n">negative_indices</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cast</span><span class="o">=</span><span class="bp">False</span><span class="p">]</span> <span class="n">states_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;F&quot;</span><span class="p">)</span>
    <span class="k">cdef</span><span class="w"> </span><span class="kt">cnp</span>.<span class="kt">ndarray</span>[<span class="kt">cnp</span>.<span class="nf">float64_t</span><span class="p">,</span> <span class="nf">ndim</span><span class="o">=</span><span class="mf">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;fortran&quot;</span><span class="p">,</span> <span class="n">negative_indices</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cast</span><span class="o">=</span><span class="bp">False</span><span class="p">]</span> <span class="n">stddev_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nfields</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;F&quot;</span><span class="p">)</span>
    <span class="k">cdef</span><span class="w"> </span><span class="kt">double</span> [<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">stddev</span> <span class="o">=</span> <span class="n">stddev_np</span>
    <span class="k">cdef</span><span class="w"> </span><span class="kt">cnp</span>.<span class="kt">ndarray</span>[<span class="kt">cnp</span>.<span class="nf">float64_t</span><span class="p">,</span> <span class="nf">ndim</span><span class="o">=</span><span class="mf">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;fortran&quot;</span><span class="p">,</span> <span class="n">negative_indices</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cast</span><span class="o">=</span><span class="bp">False</span><span class="p">]</span> <span class="n">svals_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nstates</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;F&quot;</span><span class="p">)</span>
    <span class="k">cdef</span><span class="w"> </span><span class="kt">double</span> [<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">svals</span> <span class="o">=</span> <span class="n">svals_np</span>
    <span class="k">cdef</span><span class="w"> </span><span class="kt">cnp</span>.<span class="kt">ndarray</span>[<span class="kt">cnp</span>.<span class="nf">float64_t</span><span class="p">,</span> <span class="nf">ndim</span><span class="o">=</span><span class="mf">2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;fortran&quot;</span><span class="p">,</span> <span class="n">negative_indices</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cast</span><span class="o">=</span><span class="bp">False</span><span class="p">]</span> <span class="n">svec_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="n">nstates</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;F&quot;</span><span class="p">)</span>
    <span class="k">cdef</span><span class="w"> </span><span class="kt">double</span> [<span class="p">::</span><span class="mf">1</span><span class="p">,:]</span> <span class="n">svec</span> <span class="o">=</span> <span class="n">svec_np</span>
    <span class="k">cdef</span><span class="w"> </span><span class="kt">cnp</span>.<span class="kt">ndarray</span>[<span class="kt">cnp</span>.<span class="nf">float64_t</span><span class="p">,</span> <span class="nf">ndim</span><span class="o">=</span><span class="mf">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;fortran&quot;</span><span class="p">,</span> <span class="n">negative_indices</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cast</span><span class="o">=</span><span class="bp">False</span><span class="p">]</span> <span class="n">meanstate_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">meanstate</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;F&quot;</span><span class="p">)</span>
    <span class="k">cdef</span><span class="w"> </span><span class="kt">int</span>  <span class="nf">status</span>
    <span class="k">with</span> <span class="k">nogil</span><span class="p">:</span>
        <span class="n">c__pdaf_eofcovar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dim</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nstates</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nfields</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dim_fields</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span>
                         <span class="o">&amp;</span><span class="n">offsets</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">remove_mstate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">do_mv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">states</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span>
                         <span class="o">&amp;</span><span class="n">stddev</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">svals</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">svec</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">meanstate</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span>
                         <span class="o">&amp;</span><span class="n">verbose</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">states_np</span><span class="p">,</span> <span class="n">stddev_np</span><span class="p">,</span> <span class="n">svals_np</span><span class="p">,</span> <span class="n">svec_np</span><span class="p">,</span> <span class="n">meanstate_np</span><span class="p">,</span> <span class="n">status</span>
</pre></div>
</div>
</section>
<hr class="docutils" />
<section id="handling-callback-functions">
<h4>Handling Callback Functions<a class="headerlink" href="#handling-callback-functions" title="Link to this heading">¶</a></h4>
<p>Callback functions allow users to provide information for data assimilation.
However, Fortran expects these routines to follow specific interfaces.
These are handled in <code class="docutils literal notranslate"><span class="pre">src/pyPDAF/pdaf_c_cb_interface.pxd</span></code> and corresponding
``src/pyPDAF/pdaf_c_cb_interface.pyx`.</p>
<p>Example:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">cdef</span><span class="w"> </span><span class="kt">void</span> <span class="nf">c__init_ens_pdaf</span><span class="p">(</span><span class="nb">int</span><span class="o">*</span> <span class="n">filtertype</span><span class="p">,</span> <span class="nb">int</span><span class="o">*</span> <span class="n">dim_p</span><span class="p">,</span> <span class="nb">int</span><span class="o">*</span> <span class="n">dim_ens</span><span class="p">,</span>
    <span class="n">double</span><span class="o">*</span> <span class="n">state_p</span><span class="p">,</span> <span class="n">double</span><span class="o">*</span> <span class="n">uinv</span><span class="p">,</span> <span class="n">double</span><span class="o">*</span> <span class="n">ens_p</span><span class="p">,</span> <span class="nb">int</span><span class="o">*</span> <span class="n">flag</span><span class="p">)</span> <span class="n">noexcept</span> <span class="k">with</span> <span class="k">gil</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fill the ensemble array that is provided by PDAF with an initial ensemble of model states.</span>

<span class="sd">    This function is called by :func:`pyPDAF.PDAF.init`. The initialised</span>
<span class="sd">    ensemble array will be distributed to model by :func:`pyPDAF.PDAF.init_forecast`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filtertype : int</span>
<span class="sd">            filter type given in PDAF_init</span>
<span class="sd">    dim_p : int</span>
<span class="sd">            PE-local state dimension given by PDAF_init</span>
<span class="sd">    dim_ens : int</span>
<span class="sd">            number of ensemble members</span>
<span class="sd">    state_p : ndarray[np.float64, ndim=1]</span>
<span class="sd">            PE-local model state</span>
<span class="sd">            This array must be filled with the initial</span>
<span class="sd">            state of the model for SEEK, but it is not</span>
<span class="sd">            used for ensemble-based filters.</span>
<span class="sd">            One can still make use of this array within</span>
<span class="sd">            this function.</span>
<span class="sd">            Array shape: (dim_p)</span>
<span class="sd">    uinv : ndarray[np.float64, ndim=2]</span>
<span class="sd">            This array is the inverse of matrix</span>
<span class="sd">            formed by right singular vectors of error</span>
<span class="sd">            covariance matrix of ensemble perturbations.</span>
<span class="sd">            This array has to be filled in SEEK, but it is</span>
<span class="sd">            not used for ensemble-based filters.</span>
<span class="sd">            Nevertheless, one can still make use of this</span>
<span class="sd">            array within this function e.g.,</span>
<span class="sd">            for generating an initial ensemble perturbation</span>
<span class="sd">            from a given covariance matrix.</span>
<span class="sd">            Dimension of this array is determined by the</span>
<span class="sd">            filter type.</span>
<span class="sd">            * (dim_ens, dim_ens) for (L)ETKF, (L)NETF, (L)KNETF, and SEEK</span>
<span class="sd">            * (dim_ens - 1, dim_ens - 1) for (L)SEIK, (L)ESTKF, and 3DVar using ensemble</span>
<span class="sd">            * (1, 1) for (L)EnKF, particle filters and gen_obs</span>
<span class="sd">            Array shape: (dim_ens - 1, dim_ens-1)</span>
<span class="sd">    ens_p : ndarray[np.float64, ndim=2]</span>
<span class="sd">            PE-local ensemble</span>
<span class="sd">            Array shape: (dim_p, dim_ens)</span>
<span class="sd">    flag : int</span>
<span class="sd">            pdaf status flag</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    state_p : ndarray[np.float64, ndim=1]</span>
<span class="sd">            PE-local model state</span>
<span class="sd">            This array must be filled with the initial</span>
<span class="sd">            state of the model for SEEK, but it is not</span>
<span class="sd">            used for ensemble-based filters.</span>
<span class="sd">            One can still make use of this array within</span>
<span class="sd">            this function.</span>
<span class="sd">            Array shape: (dim_p)</span>
<span class="sd">    uinv : ndarray[np.float64, ndim=2]</span>
<span class="sd">            This array is the inverse of matrix</span>
<span class="sd">            formed by right singular vectors of error</span>
<span class="sd">            covariance matrix of ensemble perturbations.</span>
<span class="sd">            This array has to be filled in SEEK, but it is</span>
<span class="sd">            not used for ensemble-based filters.</span>
<span class="sd">            Nevertheless, one can still make use of this</span>
<span class="sd">            array within this function e.g.,</span>
<span class="sd">            for generating an initial ensemble perturbation</span>
<span class="sd">            from a given covariance matrix.</span>
<span class="sd">            Dimension of this array is determined by the</span>
<span class="sd">            filter type.</span>
<span class="sd">            * (dim_ens, dim_ens) for (L)ETKF, (L)NETF, (L)KNETF, and SEEK</span>
<span class="sd">            * (dim_ens - 1, dim_ens - 1) for (L)SEIK, (L)ESTKF, and 3DVar using ensemble</span>
<span class="sd">            * (1, 1) for (L)EnKF, particle filters and gen_obs</span>
<span class="sd">            Array shape: (dim_ens - 1, dim_ens-1)</span>
<span class="sd">    ens_p : ndarray[np.float64, ndim=2]</span>
<span class="sd">            PE-local ensemble</span>
<span class="sd">            Array shape: (dim_p, dim_ens)</span>
<span class="sd">    flag : int</span>
<span class="sd">            pdaf status flag</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">cdef</span><span class="w"> </span><span class="kt">size_t</span> <span class="nf">uinv_len</span><span class="w"> </span><span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dim_ens</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">-</span><span class="mf">1</span><span class="p">,</span> <span class="mf">1</span><span class="p">)</span>
    <span class="k">cdef</span><span class="w"> </span><span class="kt">double</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">state_p_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">&lt;</span><span class="n">double</span><span class="p">[:</span><span class="n">dim_p</span><span class="p">[</span><span class="mf">0</span><span class="p">]:</span><span class="mf">1</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">state_p</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;F&quot;</span><span class="p">)</span>
    <span class="k">cdef</span><span class="w"> </span><span class="kt">double</span>[<span class="p">::</span><span class="mf">1</span><span class="p">,:]</span> <span class="n">uinv_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">&lt;</span><span class="n">double</span><span class="p">[:</span><span class="n">uinv_len</span><span class="p">:</span><span class="mf">1</span><span class="p">,:</span><span class="n">uinv_len</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">uinv</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;F&quot;</span><span class="p">)</span>
    <span class="k">cdef</span><span class="w"> </span><span class="kt">double</span>[<span class="p">::</span><span class="mf">1</span><span class="p">,:]</span> <span class="n">ens_p_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">&lt;</span><span class="n">double</span><span class="p">[:</span><span class="n">dim_p</span><span class="p">[</span><span class="mf">0</span><span class="p">]:</span><span class="mf">1</span><span class="p">,:</span><span class="n">dim_ens</span><span class="p">[</span><span class="mf">0</span><span class="p">]]</span><span class="o">&gt;</span> <span class="n">ens_p</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;F&quot;</span><span class="p">)</span>

    <span class="n">state_p_np</span><span class="p">,</span><span class="n">uinv_np</span><span class="p">,</span><span class="n">ens_p_np</span><span class="p">,</span><span class="n">flag</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(&lt;</span><span class="kt">object</span><span class="p">&gt;</span><span class="n">init_ens_pdaf</span><span class="p">)(</span>
                                                                  <span class="n">filtertype</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span>
                                                                  <span class="n">dim_p</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span>
                                                                  <span class="n">dim_ens</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span>
                                                                  <span class="n">state_p_np</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
                                                                  <span class="n">uinv_np</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
                                                                  <span class="n">ens_p_np</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
                                                                  <span class="n">flag</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>

    <span class="k">cdef</span><span class="w"> </span><span class="kt">double</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">state_p_new</span>
    <span class="k">if</span> <span class="n">state_p</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">state_p_np</span><span class="p">[</span><span class="mf">0</span><span class="p">]:</span>
        <span class="n">state_p_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">&lt;</span><span class="n">double</span><span class="p">[:</span><span class="n">dim_p</span><span class="p">[</span><span class="mf">0</span><span class="p">]:</span><span class="mf">1</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">state_p</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;F&quot;</span><span class="p">)</span>
        <span class="n">state_p_new</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_p_np</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;The memory address of state_p is changed in c__add_obs_err_pdaf.&quot;</span>
            <span class="s">&quot;The values are copied to the original Fortran array, and can slow-down the system.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
    <span class="k">cdef</span><span class="w"> </span><span class="kt">double</span>[<span class="p">::</span><span class="mf">1</span><span class="p">,:]</span> <span class="n">uinv_new</span>
    <span class="k">if</span> <span class="n">uinv</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">uinv_np</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">]:</span>
        <span class="n">uinv_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">&lt;</span><span class="n">double</span><span class="p">[:</span><span class="n">uinv_len</span><span class="p">:</span><span class="mf">1</span><span class="p">,:</span><span class="n">uinv_len</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">uinv</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;F&quot;</span><span class="p">)</span>
        <span class="n">uinv_new</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">uinv_np</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;The memory address of uinv is changed in c__add_obs_err_pdaf.&quot;</span>
            <span class="s">&quot;The values are copied to the original Fortran array, and can slow-down the system.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
    <span class="k">cdef</span><span class="w"> </span><span class="kt">double</span>[<span class="p">::</span><span class="mf">1</span><span class="p">,:]</span> <span class="n">ens_p_new</span>
    <span class="k">if</span> <span class="n">ens_p</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">ens_p_np</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">]:</span>
        <span class="n">ens_p_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">&lt;</span><span class="n">double</span><span class="p">[:</span><span class="n">dim_p</span><span class="p">[</span><span class="mf">0</span><span class="p">]:</span><span class="mf">1</span><span class="p">,:</span><span class="n">dim_ens</span><span class="p">[</span><span class="mf">0</span><span class="p">]]</span><span class="o">&gt;</span> <span class="n">ens_p</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;F&quot;</span><span class="p">)</span>
        <span class="n">ens_p_new</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">ens_p_np</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;The memory address of ens_p is changed in c__add_obs_err_pdaf.&quot;</span>
            <span class="s">&quot;The values are copied to the original Fortran array, and can slow-down the system.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">init_ens_pdaf</span></code> is defined in <code class="docutils literal notranslate"><span class="pre">src/pyPDAF/pdaf_c_cb_interface.pxd</span></code> as a pointer:
<code class="docutils literal notranslate"><span class="pre">cdef</span> <span class="pre">void*</span>&#160; <span class="pre">init_ens_pdaf</span> <span class="pre">=</span> <span class="pre">NULL;</span></code>.
The pointer is associated in pyPDAF functions, for example, in <code class="docutils literal notranslate"><span class="pre">src/pyPDAF/PDAF3/_pdaf3_c.pyx</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="k">from</span><span class="w"> </span><span class="nn">pyPDAF</span><span class="w"> </span><span class="k">cimport</span> <span class="n">pdaf_c_cb_interface</span> <span class="k">as</span> <span class="n">pdaf_cb</span>
<span class="n">pdaf_cb</span><span class="o">.</span><span class="n">init_ens_pdaf</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">void</span><span class="o">*&gt;</span><span class="n">py__init_ens_pdaf</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">py__init_ens_pdaf</span></code> is the Python call-back function. The C function,
<code class="docutils literal notranslate"><span class="pre">pdaf_cb.c__init_ens_pdaf</span></code>, is
used for calling Fortran subroutines:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span>    <span class="k">with</span> <span class="k">nogil</span><span class="p">:</span>
        <span class="n">c__pdaf3_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">filtertype</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subtype</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stepnull</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param_int</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span>
                     <span class="o">&amp;</span><span class="n">dim_pint</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param_real</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">dim_preal</span><span class="p">,</span>
                     <span class="n">pdaf_cb</span><span class="o">.</span><span class="n">c__init_ens_pdaf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in_screen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">outflag</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="caveats">
<h4>Caveats<a class="headerlink" href="#caveats" title="Link to this heading">¶</a></h4>
<ol class="arabic simple">
<li><p><strong>Pass-by-Reference in Fortran:</strong> Fortran passes arguments by reference, while Python’s behavior depends on the object type.</p></li>
<li><p><strong>Maintaining Consistency:</strong> When Python functions modify arguments, ensure the original reference is preserved.</p></li>
</ol>
<p>Example Safety Check:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">cdef</span> <span class="n">double</span><span class="p">[::</span><span class="mi">1</span><span class="p">]</span> <span class="n">state_p_new</span>
    <span class="k">if</span> <span class="n">state_p</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">state_p_np</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">state_p_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="o">&lt;</span><span class="n">double</span><span class="p">[:</span><span class="n">dim_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">&gt;</span> <span class="n">state_p</span><span class="p">)</span>
        <span class="n">state_p_new</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">state_p_np</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The memory address of state_p is changed in c__init_ens_pdaf.&quot;</span>
         <span class="s2">&quot;The values are copied to the original Fortran array, and can slow-down the system.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="exposing-the-function-to-pypdaf-and-mypy">
<h4>Exposing the function to pyPDAF and Mypy<a class="headerlink" href="#exposing-the-function-to-pypdaf-and-mypy" title="Link to this heading">¶</a></h4>
<p>To expose your function to pyPDAF or subpackages of pyPDAF, you need to import
it in <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> in corresponding directories. Further, as pyPDAF supports
type checking and other Python support features. You can add typing and docstring
to stub files ending with <code class="docutils literal notranslate"><span class="pre">.pyi</span></code>.</p>
</section>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">pyPDAF</a></h1>



<p class="blurb">A Python interface to Parallel Data Assimilation Framework.</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=yumengch&repo=pyPDAF&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="parallel.html">Parallelisation Strategy</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Developer Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adding-a-new-fortran-function-in-pypdaf">Adding a new Fortran function in pyPDAF</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="API.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="hidden_functions.html">Legacy and internal PDAF functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="hidden_functions.html#pypdaf-pdaflocal">pyPDAF.PDAFlocal</a></li>
<li class="toctree-l1"><a class="reference internal" href="hidden_functions.html#pypdaf-pdaflocalomi">pyPDAF.PDAFlocalomi</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="parallel.html" title="previous chapter">Parallelisation Strategy</a></li>
      <li>Next: <a href="API.html" title="next chapter">API</a></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2022 University of Reading and National Centre for Earth Observation.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.3.0</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/develop.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>